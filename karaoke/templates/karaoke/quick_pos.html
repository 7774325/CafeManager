{% extends 'core/base.html' %}
{% block content %}
<style>
    .pos-grid { height: 75vh; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; }
    .item-card { 
        background: white; border-radius: 12px; border: 1px solid #e0e0e0; 
        transition: all 0.2s ease; cursor: pointer; height: 140px;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .item-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: #0d6efd; }
    .ticket-sidebar { background: white; border-left: 1px solid #dee2e6; min-height: 90vh; display: flex; flex-direction: column; }
    .ticket-header { padding: 20px; border-bottom: 2px solid #f8f9fa; background: #ffffff; }
    .ticket-items { flex-grow: 1; overflow-y: auto; padding: 15px; }
    .ticket-footer { padding: 25px; border-top: 2px solid #f8f9fa; background: #ffffff; }
    .category-btn { border-radius: 20px; padding: 5px 20px; margin-bottom: 10px; font-weight: 500; }
</style>

<div class="container-fluid p-0">
    <div class="row g-0">
        <div class="col-md-8 p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex gap-2 overflow-auto pb-2" id="categoryTabs">
                    <button class="btn btn-primary category-btn">All Items</button>
                    <button class="btn btn-outline-secondary category-btn">Coffee</button>
                    <button class="btn btn-outline-secondary category-btn">Snacks</button>
                </div>
                <div class="w-25">
                    <input type="text" id="posSearch" class="form-control" placeholder="Search menu...">
                </div>
            </div>
            
            <div class="pos-grid border shadow-sm">
                <div class="row g-3" id="posItems">
                    {% for product in products %}
                    <div class="col-6 col-sm-4 col-xl-3 pos-item" data-name="{{ product.name|lower }}">
                        <div class="item-card add-to-cart" 
                             data-id="{{ product.id }}" 
                             data-name="{{ product.name }}" 
                             data-price="{{ product.selling_price }}">
                            <div class="mb-2 text-primary"><i class="fas fa-utensils fa-2x"></i></div>
                            <div class="fw-bold text-dark px-2">{{ product.name }}</div>
                            <div class="text-muted small mt-1">{{ outlet.primary_currency }} {{ product.selling_price }}</div>
                            {% if product.current_stock_level < 5 %}
                                <span class="badge bg-warning text-dark position-absolute top-0 end-0 m-2">Low Stock: {{ product.current_stock_level }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-4 ticket-sidebar shadow-lg">
            <div class="ticket-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0 fw-bold"><i class="fas fa-receipt me-2 text-primary"></i>Current Ticket</h4>
                <button class="btn btn-sm btn-outline-danger border-0" onclick="clearCart()"><i class="fas fa-trash me-1"></i>Clear</button>
            </div>
            
            <div class="ticket-items" id="cartList">
                <div class="text-center text-muted mt-5">
                    <i class="fas fa-shopping-cart fa-3x mb-3 opacity-25"></i>
                    <p>Select items to start an order</p>
                </div>
            </div>

            <div class="ticket-footer">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <span class="h5 mb-0 text-muted">Total Amount</span>
                    <span class="h3 mb-0 fw-bold text-primary">{{ outlet.primary_currency }} <span id="cartTotal">0.00</span></span>
                </div>
                <form method="POST" action="{% url 'quick_pos' %}" id="posForm">
                    {% csrf_token %}
                    <div id="hiddenInputs"></div>
                    <div class="row g-2">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-lg w-100 py-3 fw-bold shadow">
                                <i class="fas fa-check-circle me-2"></i>CHARGE & COMPLETE SALE
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let cart = {};
    const symbol = "{{ outlet.primary_currency }}";

    document.querySelectorAll('.add-to-cart').forEach(card => {
        card.onclick = function() {
            const id = this.dataset.id;
            const name = this.dataset.name;
            const price = parseFloat(this.dataset.price);

            if (cart[id]) {
                cart[id].qty++;
            } else {
                cart[id] = { name, price, qty: 1 };
            }
            updateTicket();
        };
    });

    function updateTicket() {
        const list = document.getElementById('cartList');
        const hidden = document.getElementById('hiddenInputs');
        list.innerHTML = '';
        hidden.innerHTML = '';
        let total = 0;

        const cartKeys = Object.keys(cart);
        if (cartKeys.length === 0) {
            list.innerHTML = `
                <div class="text-center text-muted mt-5">
                    <i class="fas fa-shopping-cart fa-3x mb-3 opacity-25"></i>
                    <p>Select items to start an order</p>
                </div>`;
        }

        cartKeys.forEach(id => {
            const item = cart[id];
            const lineTotal = item.price * item.qty;
            total += lineTotal;
            
            list.innerHTML += `
                <div class="d-flex justify-content-between align-items-center mb-4 animate__animated animate__fadeIn">
                    <div class="flex-grow-1">
                        <div class="fw-bold text-dark">${item.name}</div>
                        <div class="text-muted small">${symbol} ${item.price.toFixed(2)} x ${item.qty}</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-primary">${symbol} ${lineTotal.toFixed(2)}</div>
                        <button type="button" class="btn btn-sm p-0 text-danger border-0" onclick="removeItem('${id}')">Remove</button>
                    </div>
                </div>
            `;

            hidden.innerHTML += `
                <input type="hidden" name="items" value="${id}">
                <input type="hidden" name="qty_${id}" value="${item.qty}">
            `;
        });
        document.getElementById('cartTotal').innerText = total.toFixed(2);
    }

    function removeItem(id) {
        if (cart[id].qty > 1) {
            cart[id].qty--;
        } else {
            delete cart[id];
        }
        updateTicket();
    }

    function clearCart() {
        if(confirm("Discard this ticket?")) {
            cart = {};
            updateTicket();
        }
    }

    // Live Search
    document.getElementById('posSearch').addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.pos-item').forEach(item => {
            const name = item.dataset.name;
            item.style.display = name.includes(term) ? 'block' : 'none';
        });
    });
</script>
{% endblock %}