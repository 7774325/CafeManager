{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card border-0 shadow-sm p-4" id="printableReceipt" style="font-family: 'Courier New', Courier, monospace;">
                <div class="text-center mb-4">
                    <h3 class="fw-bold mb-0 text-uppercase">CHILLOKAY</h3>
                    <p class="small text-muted mb-0">Mal√©, Maldives</p>
                    <p class="small text-muted">Tel: +960 7xxxxxx</p>
                    <hr class="border-secondary border-dashed">
                </div>

                <div class="d-flex justify-content-between mb-2 small">
                    <span>Receipt #:</span>
                    <span class="fw-bold text-uppercase">{{ sale.id }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2 small">
                    <span>Date:</span>
                    <span>{{ sale.date|date:"d/m/Y H:i" }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2 small">
                    <span>Customer:</span>
                    <span class="fw-bold">
                        {% if sale.customer_name %}{{ sale.customer_name }}{% elif sale.customer %}{{ sale.customer.name }}{% else %}Walk-in{% endif %}
                    </span>
                </div>
                
                <hr class="border-secondary border-dashed">

                <div class="row g-0 fw-bold small mb-2 text-uppercase">
                    <div class="col-7">Item</div>
                    <div class="col-2 text-center">Qty</div>
                    <div class="col-3 text-end">Price</div>
                </div>

                {% for item in sale.items.all %}
                <div class="row g-0 small mb-1">
                    <div class="col-7">{{ item.product.name }}</div>
                    <div class="col-2 text-center">x{{ item.quantity }}</div>
                    <div class="col-3 text-end">MVR {{ item.price }}</div>
                </div>
                {% empty %}
                <div class="text-center py-2 small italic text-muted">Karaoke Session Charges Apply</div>
                {% endfor %}

                <hr class="border-secondary border-dashed">

                <div class="d-flex justify-content-between mb-1 fw-bold fs-5">
                    <span>TOTAL</span>
                    <span>MVR {{ sale.total_amount }}</span>
                </div>
                <div class="d-flex justify-content-between small text-muted">
                    <span>Payment Method:</span>
                    <span class="text-uppercase">{{ sale.payment_method }}</span>
                </div>

                <div class="text-center mt-5">
                    <p class="small mb-0">Thank You for Visiting!</p>
                    <p class="small">Please come again.</p>
                    <div class="mt-2">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data={{ request.build_absolute_uri }}" alt="QR Code" class="opacity-50">
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mt-3 d-print-none bg-light">
                <div class="card-body p-3">
                    <small class="text-muted text-uppercase fw-bold d-block mb-2">Share Digital Receipt</small>
                    <div class="d-flex gap-2">
                        <a href="https://wa.me/?text=Your%20ChillOkay%20Receipt:%20{{ request.build_absolute_uri|urlencode }}" 
                           target="_blank" class="btn btn-success flex-grow-1">
                            <i class="fab fa-whatsapp me-2"></i> WhatsApp
                        </a>
                        <button onclick="copyReceiptLink()" class="btn btn-outline-dark">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 mt-3 d-print-none">
                <button onclick="window.print()" class="btn btn-dark btn-lg">
                    <i class="fas fa-print me-2"></i> Print Physical Receipt
                </button>
                <a href="{% url 'sales_history' %}" class="btn btn-link text-muted text-decoration-none">
                    <i class="fas fa-arrow-left me-2"></i> Back to History
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    @media print {
        body * { visibility: hidden; }
        #printableReceipt, #printableReceipt * { visibility: visible; }
        #printableReceipt {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            box-shadow: none !important;
            padding: 0 !important;
        }
        .d-print-none { display: none !important; }
    }
    .border-dashed { border-style: dashed !important; border-top: 1px dashed #ccc !important; }
</style>

<script>
function copyReceiptLink() {
    navigator.clipboard.writeText(window.location.href);
    alert("Receipt link copied to clipboard!");
}
</script>
{% endblock %}